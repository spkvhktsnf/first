'use strict';const RE=RegExp,CL=console.log,JS=JSON.stringify,JP=JSON.parse,DN=Date.now,ZL=require('zlib'),FS=require('fs'),CR=require('crypto'),SW=require('stream').Writable,SR=require('stream').Readable,http=require('https'),config=require('./package.json').config
,rw={wbF:async(a,b,c)=>{const d=FS.createWriteStream(b.data+a+'.'+b.zip),e=new SR;e.push(JS(c[a])),e.push(null),e.pipe(ZL.createDeflate()).pipe(d),b.is_debug&&CL(`BACKUP wbF ${a} RECS ${c[a].length}`)},rbf:async(a,b,c)=>{const d=FS.createReadStream(b.data+a+'.'+b.zip),e=new SW;let f=[],g=0;e.on('error',(b)=>CL('ERROR WRITESTREAM',a,b)),e.on('finish',()=>{let d=Buffer.alloc(g);for(let a=0,b=f.length,c=0;a<b;a++)f[a].copy(d,c),c+=f[a].length;c[a]=JP(d.toString()),c._all[a]=c[a].length,b.is_debug&&CL(`Finish WRITESTREAM for ${a} LEN ${g} RECS ${c[a].length}`)}),e.write=(a)=>{f.push(a),g+=a.length},d.pipe(ZL.createInflate()).pipe(e)},rbfa:async(a,b)=>{await Promise.all(a.tabs.map(async(c)=>rw.rbf(c,a,b)))},rdf:async(a,b)=>FS.readdir(a.app,(c,e)=>e.forEach((c)=>FS.readFile(a.app+c,(d,e)=>{if(d)throw d;let f=a.is_fcrypt?CR.createHmac('sha256',a.cert+DN()).update(c).digest('hex'):c;b._file[c]=f,b[f]=e,a.is_debug&&CL(`fcrypt ${a.is_fcrypt} FILE ${c} loaded ${e.length} ${f}`)})))},filters={eF:(a)=>(b)=>(c)=>c[a].toString()===b.toString(),rF:(a)=>(b)=>(c)=>new RE(b,'i').test(c[a]),NrF:(a)=>(b)=>(c)=>!new RE(b,'i').test(c[a]),tF:(a)=>()=>(b)=>b[a],NtF:(a)=>()=>(b)=>!b[a],gF:(a)=>(b)=>(c)=>c[a]>=b,lF:(a)=>(b)=>(c)=>c[a]<=b,bF:(a)=>(b)=>(c)=>c[a]>=b.k&&c[a]<=b.g,NbF:(a)=>(b)=>(c)=>c[a]<=b.k&&c[a]>=b.g,iF:(b)=>(c)=>(a)=>new RE(c.join('|')).test(a[b]),mfs:(d)=>(a)=>(b)=>d.reduce((c,e)=>c||new RE(a,'i').test(b[e].replace(/[<>;:\- ./\\]/g,'')),!1)},mfms=(d)=>(a,b)=>a.filter(filters.mfs(d)(b)),eof=(a)=>(b,c)=>{return-1===b.indexOf(c[a])&&b.push(c[a]),b},fc=(a,b)=>a.filter(filters[b.f](b.k)(b.v)),fo=(a,b)=>(c,d)=>c.concat(a.filter((a)=>a[b]===d)),as=(c)=>(d)=>c.reduce((b,a)=>{return b[a]=d[a],b},{}),icuv=(a,b)=>{return a._id=a._id||'VSMC'+DN().toString(35)+b,a._ctime=a._ctime||DN(),a._utime=DN(),a._version=(a._version||0)+1,a},bxpl=(b)=>{const a=b.map((a)=>a||0).sort();return{min:a[0],q1:a[parseInt(0.25*a.length)],q5:a[parseInt(0.5*a.length)],mean:a.reduce((b,c,d,e)=>b+(c||0)/e.length,0),q7:a[parseInt(0.75*a.length)],max:a[a.length-1],l:a.length}},FC=(a,b='')=>new Promise((c,d)=>{'https'===a.prot&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED='0');const e=require(a.prot).request({host:a.host,port:a.port,method:a.method,path:a.path,headers:{Accept:'application/json',Authorization:'Basic '+a.auth,"x-encoding":a.senc?'deflate':'',"accept-encoding":a.renc?'deflate':''}},(b)=>{let e=new SW,f=[],g=0;e.write=(a)=>{f.push(a),g+=a.length},e.on('error',(a)=>{d('XRES-ErRor: '+a.message)}),e.on('finish',()=>{let a=Buffer.alloc(g);for(let b=0,c=f.length,d=0;b<c;b++)f[b].copy(a,d),d+=f[b].length;c(a.toString())}),a.renc?b.pipe(ZL.createInflate()).pipe(e):b.pipe(e)});e.on('error',(a)=>{d('XREQ-ERror: '+a.message)});let f=new SR;f.push(b),f.push(null),a.senc?f.pipe(ZL.createDeflate()).pipe(e):f.pipe(e)}),FCSD=async(a,b)=>{await FC(a,b)},rest=(a,b,c,d,e,f)=>{const g=c[2],h=f&&JSON.parse(f);switch(a.is_debug&&CL(`-----------REST_${b}${c.length} ${g} ${d[g]&&d[g].length} ${f.slice(0,30)}`),b){case'GET':switch(c.length){case 3:'_cmd'===g?(a.is_debug&&CL('Wir haben ein sfunc',h.sfunc,h.cmd),h.sfunc&&Function.apply(null,h.sfunc)(d,null),h.cmd&&Function.apply(null,d.commands.filter((a)=>a.cmd===h.cmd)[0].sfunc)(d,null)):e.push(JS(d[g]?d[g]:[{no:'nothing'}]));break;case 4:switch(c[3]){case'_arfield':e.push(JS(d[g]?h.ar.reduce(fo(d[g],h.field),[]):[{no:'nothing'}]));break;case'_ids':e.push(JS(d[g]?h.reduce(fo(d[g],'_id'),[]):[{no:'nothing'}]));break;case'_first':e.push(JS(d[g]?d[g][0]:[{no:'nothing'}]));break;case'_last':e.push(JS(d[g]?d[g][d[g].length-1]:[{no:'nothing'}]));break;case'_first5':e.push(JS(d[g]?d[g].slice(0,5):[{no:'nothing'}]));break;case'_last5':e.push(JS(d[g]?d[g].slice(-5):[{no:'nothing'}]));break;case'_version5':e.push(JS(d[g]?d[g].sort((c,a)=>a._version-c._version).slice(0,5):[{no:'nothing'}]));break;case'_utime5':e.push(JS(d[g]?d[g].sort((c,a)=>a._utime-c._utime).slice(0,5):[{no:'nothing'}]));break;case'_filter':e.push(JS(d[g]?h.reduce(fc,d[g]):[{no:'nothing'}]));break;case'_structure':e.push(JS(d[g]?d[g].map(as(h)):[{no:'nothing'}]));break;case'_combine':e.push(JS(d[g]?h.filter.reduce(fc,d[g]).map(as(h.structure)):[{no:'nothing'}]));break;case'_ocombine':e.push(JS(d[g]?h.filter.reduce(fc,h.ar.reduce(fo(d[g],h.field),[])).map(as(h.structure)):[{no:'nothing'}]));break;case'_mcombine':e.push(JS(d[g]?h.searchvalues.split(' ').reduce(mfms(h.searchfields),h.filter.reduce(fc,d[g])).map(as(h.structure)):[{no:'nothing'}]));break;default:if('_cmd'===g){e.push(JS(Function.apply(null,Array.prototype.filter.call(d.commands,(a)=>a.cmd===c[3])[0].sfunc)(d,null)));break}if('_app'===g){let a=Buffer.from(d[g].filter((a)=>a._id===c[3])[0].content,'hex').toString('utf8');e.push(a);break}}break;case 5:e.push(JS(d[g]?d[g].filter((a)=>a[c[3]]===c[4]):[{no:'nothing'}]));break;default:e.push('{}');}break;case'POST':switch(c.length){case 3:'_bulk'===g?(h.forEach((a)=>{d[a.index]||(d[a.index]=[]),d[a.index].P(icuv(a.row,0))}),h.map((a)=>a.index).forEach((a)=>{d._utc[a]=DN(),d._all[a]=d[a].length})):(!d[g]&&(d[g]=[]),d[g].push(icuv(h,0)),d._utc[g]=DN(),d._all[g]=d[g].length),e.push('{}');break;case 4:switch(c[3]){case'_fetch':FCSD(h,JS(d[g]));break;case'_ffetch':FCSD(h.server,JS(h.filter.reduce(fc,d[g])));break;case'_fcfetch':FCSD(h.server,JS(h.filter.reduce(fc,d[g]).map(as(h.structure))));break;case'_ofetch':FCSD(h.server,JS(h.ar.reduce(fo(d[g],h.field),[])));break;case'_fcofetch':FCSD(h.server,JS(h.filter.reduce(fc,h.ar.reduce(fo(d[g],h.field),[])).map(as(h.structure))));break;case'_arfield':e.push(JS(d[g]?h.ar.reduce(fo(d[g],h.field),[]):[{no:'nothing'}]));break;case'_ids':e.push(JS(d[g]?h.reduce(fo(d[g],'_id'),[]):[{no:'nothing'}]));break;case'_summary':let a=h.reduce((a,b)=>{return a[b]={},a},{});e.push(JS(d[g].reduce((b,c)=>{return Object.keys(a).forEach((a)=>{b[a][c[a]]=(b[a][c[a]]||0)+1}),b},a)));break;case'_fsummary':let b=h.structure.reduce((a,b)=>{return a[b]={},a},{});e.push(JS(h.filter.reduce(fc,d[g]).reduce((a,c)=>{return Object.keys(b).forEach((b)=>{a[b][c[b]]=(a[b][c[b]]||0)+1}),a},b)));break;case'_osummary':let f=h.reduce((a,b)=>{return a[b]={},a[b].count=[],a[b].eof=d[g].reduce(eof(b),[]),a[b].count=a[b].eof.reduce((a,c)=>{return a.push(d[g].filter((a)=>a[b]===c).length),a},[]),a},{});e.push(JS(f));break;case'_boxplot':let i=h.reduce((a,b)=>{return a[b]=bxpl(d[g].map((a)=>a[b])),a},{});e.push(JS(i));break;case'_fboxplot':let j=h.structure.reduce((a,b)=>{return a[b]=bxpl(h.filter.reduce(fc,d[g]).map((a)=>a[b])),a},{});e.push(JS(j));break;case'_filter':e.push(JS(d[g]?h.reduce(fc,d[g]):[{no:'nothing'}]));break;case'_combine':e.push(JS(d[g]?h.filter.reduce(fc,d[g]).map(as(h.structure)):[{no:'nothing'}]));break;case'_structure':e.push(JS(d[g]?d[g].map(as(h)):[{no:'nothing'}]));break;case'_ocombine':e.push(JS(d[g]?h.filter.reduce(fc,h.ar.reduce(fo(d[g],h.field),[])).map(as(h.structure)):[{no:'nothing'}]));break;case'_mcombine':e.push(JS(d[g]?h.searchvalues.split(' ').reduce(mfms(h.searchfields),h.filter.reduce(fc,d[g])).map(as(h.structure)):[{no:'nothing'}]));break;case'_bulk':d[g]||(d[g]=[]),h.forEach(icuv),d[g]=d[g].concat(h),d._utc[g]=DN(),d._all[g]=d[g].length;}break;case 5:switch(CL(5,'POST',c[3],c[4]),c[4]){case'raspc':CL(5,'POST','raspc'),require('./swSendUDP')(h);break;case'mail':CL(5,'POST','mail',h),require('./swMailClient')(h);}break;case 6:let a=d[g].filter((a)=>a._id===c[3]);1===a.length&&(a[0][c[4]]=c[5],a[0]=icuv(a[0],0));break;default:e.push('{}');}break;case'PUT':switch(c.length){case 3:if(!d[g])d[g]=[],d[g].push(icuv(h,0));else{let a=d[g].filter((a)=>a._id===h._id);1===a.length&&(Object.keys(h).forEach((b)=>{a[0][b]=h[b]}),a[0]=icuv(a[0],0))}break;case 6:let a=d[g].filter((a)=>a._id===c[3]);1===a.length&&(a[0][c[4]]=c[5],a[0]=icuv(a[0],0));break;case 4:if(!d[g])d[g]=[];else{let a=d[g].filter((a)=>a._id===c[3]);1===a.length&&(Object.keys(h).forEach((b)=>{a[0][b]=h[b]}),a[0]=icuv(a[0],0))}}d._utc[g]=DN();break;case'DELETE':switch(c.length){case 3:d[g]=[];break;case 4:switch(c[3]){case'_filter':d[g]=h.reduce(fc,d[g]);break;case'_structure':h.forEach((a)=>{d[g].forEach((b)=>b[a]&&delete b[a])});break;default:d[g]=d[g].filter((a)=>a._id!==c[3]);};}d._utc[g]=DN(),d._all[g]=d[g].length;}}
,port=process.env.PORT||process.env.OPENSHIFT_NODEJS_PORT||config.webport,ipaddress=process.env.IP||process.env.OPENSHIFT_NODEJS_IP||'0.0.0.0',router=(a,b,c,d)=>{let e='';const f=a.method,g=a.url,h=a.headers['accept-encoding']||'ac.n.v.',i=a.headers['x-encoding']||'xe.n.v.',j=/rest\//.test(g),k=/rest\/_app\//.test(g),l=/event-source\//.test(g),m=!(j||l),n=g.split('?')[0].split('/'),o=n[j||l?2:1],p=h&&h.match(/\bdeflate\b/),q=i&&i.match(/\bdeflate\b/);d.is_debug&&CL(`ROUTER X ${i}[${q}] AC ${h}[${p}] URL ${a.url} METHOD ${a.method}`),d.is_log&&c._log.push({time:DN(),method:a.method,path:a.url,remote:a.connection.remoteAddress.split(':').pop()});let r=new SW,s=[],t=0;r.on('finish',()=>{let a=Buffer.alloc(t);for(let b=0,c=s.length,d=0;b<c;b++)s[b].copy(a,d),d+=s[b].length;e=a.toString(),d.is_debug&&CL('WRITESTREAM-FINISHED',a.toString('hex').slice(0,100)),d.is_debug&&CL(`Finish WRITESSTREAM for LEN ${t} ${e.length} `),b.setHeader('Access-Control-Allow-Origin','*'),b.writeHead(200,{"content-encoding":'deflate',"content-type":j&&!k?'application/json':''});let g=new SR;m&&g.push(c[o]?c[o]:c[d.first]),j&&rest(d,f,n,c,g,e),l,g.push(null),p?g.pipe(ZL.createDeflate()).pipe(b):g.pipe(b)}),r.write=(a)=>{s.push(a),t+=a.length},i&&i.match(/\bdeflate\b/)?(d.is_debug&&CL('wir haben ein deflate'),a.pipe(ZL.createInflate()).pipe(r)):a.pipe(r),a.on('end',()=>{d.is_debug&&CL(`REQONEND ${k?'FREST':''} ${m?'FILE':''} ${j?'REST':''} ${l?'EVENT':''} [${f}] ${g}(${n.length}) index:${o} data.l:${e.length} zip:${p}`)})};let data={_utc:{},_log:[],_file:{},_app:[],_all:{},default:' ',login:'login sonst nix'},stime=DN();config.is_data&&rw.rbfa(config,data),config.is_app&&rw.rdf(config,data),config.is_backup&&setInterval(()=>{Object.keys(data._utc).filter((a)=>data._utc[a]>stime).forEach(async(a)=>await rw.wbF(a,config,data)),stime=DN()},config.backup_time),http.createServer({key:FS.readFileSync('cert/'+config.cert+'.key.pem'),cert:FS.readFileSync('cert/'+config.cert+'.server.crt')},(a,b)=>router(a,b,data,config)).listen(port,ipaddress,()=>{config.is_debug&&CL(`listen on webport ${port} ${ipaddress}`)});
